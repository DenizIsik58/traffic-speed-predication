{% extends "base.html" %}

{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="/static/css/finmap.css"/>
{% endblock %}

{% block content %}
    <!-- Css applied in a different file do not seem to apply. Must be written in header -->
    <div id='map' style='width: 100%; height: 100%; position: relative'>
        <div>
            <p id="text">HEJ</p>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidnNvbi1zb2xpdGEiLCJhIjoiY2wxNmlqcG5jMDdyMjNkcGt1N241bTV3eSJ9.R4IzYACNR4PEWDAoBlTkYw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [26, 62.3], // starting position
            zoom: 5, // starting zoom
        });

        //just for getting things rolling
        var numberOfRoads = 0;
        var debug = false;

        //would be very cool to save this to localStorage
        var selectedRoads = []

        map.on('load', () => {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mousemove', (e) => {
            document.getElementById('footer').innerHTML = JSON.stringify(e.lngLat.wrap());
            
        });

        map.on('click', (e) => {
            mouseCoords = e.lngLat.wrap()

            promise = fetch_prediction(mouseCoords)

            document.getElementById('footer').innerHTML = JSON.stringify(e.lngLat.wrap());

            //handle the road object fetched from the coordinates
            promise.then(function(result) {
                const closestRoad = result.roadId;
                const closestRoadSection = result.roadSectionId;
                const predition = result.predictedSpeed;

                //console.log(result)

                //get the full coordinates of this road
                //const newPromise = fetch_coordinates(closestRoad)
                const geodataPromise = fetch_geodata(closestRoad, closestRoadSection)

                geodataPromise.then(function(geodata) {
                    // Bit of a tricky path, just the way the json is formatted
                    //const finalCoords = newResult.features[0].geometry.coordinates//JSON.stringify(newResult.features)

                    //newResult.features.forEach(element => {
                    //    const finalCoords = element.geometry.coordinates
                    //    load_road_from_geojson(numberOfRoads.toString(), numberOfRoads.toString(), finalCoords)
                    //    numberOfRoads++;
                    //});

                    //const finalCoords = newResult.features

                    //for (let index = 0; index <30; index++) {
                    //    const element = finalCoords[index].geometry.coordinates;
                    //    load_road_from_geojson(predition, numberOfRoads.toString(), numberOfRoads.toString(), element)
                    //    numberOfRoads++;
                    //}

                    //load_road_from_geojson(numberOfRoads.toString(), numberOfRoads.toString(), finalCoords)
                    //numberOfRoads++;

                    load_road_from_geojson(predition, numberOfRoads.toString(), numberOfRoads.toString(), geodata)
                    numberOfRoads++;

                    if(debug) 
                    {
                        console.log("THE ROAD WE ARE LOOKING FOR HAS ID: " + result.toadId)
                        console.log("Coords at mouse: " + mouseCoords);
                        console.log("closestRoad: " + closestRoad)
                        //console.log("Coords of road: " + newResult.features[0].geometry.coordinates)
                    }
                })
            })
            
            //load_road_from_geojson("1", "1", [ [ [ 22.989759, 59.831637 ], [ 22.989925, 59.831699 ], [ 22.990181, 59.831901 ], [ 22.990198, 59.831922 ], [ 22.990235, 59.831986 ] ], [ [ 22.990235, 59.831986 ], [ 22.990335, 59.832141 ], [ 22.990480, 59.832380 ], [ 22.990660, 59.832672 ], [ 22.990789, 59.832890 ], [ 22.990872, 59.833019 ] ], [ [ 22.990872, 59.833019 ], [ 22.991010, 59.833262 ], [ 22.991145, 59.833506 ], [ 22.991241, 59.833819 ], [ 22.991258, 59.834181 ], [ 22.991244, 59.834591 ], [ 22.991238, 59.834722 ] ], [ [ 22.991238, 59.834722 ], [ 22.991237, 59.834855 ], [ 22.991250, 59.835067 ], [ 22.991269, 59.835206 ], [ 22.991314, 59.835381 ], [ 22.991363, 59.835500 ] ], [ [ 22.991363, 59.835500 ], [ 22.991534, 59.835715 ], [ 22.991871, 59.836055 ], [ 22.992185, 59.836269 ] ], [ [ 22.992185, 59.836269 ], [ 22.992334, 59.836353 ], [ 22.992871, 59.836653 ], [ 22.993557, 59.837021 ], [ 22.994231, 59.837374 ], [ 22.994287, 59.837403 ], [ 22.994861, 59.837673 ], [ 22.995027, 59.837747 ] ], [ [ 22.995027, 59.837747 ], [ 22.995053, 59.837759 ], [ 22.995244, 59.837845 ] ], [ [ 22.995244, 59.837845 ], [ 22.995425, 59.837926 ], [ 22.995629, 59.838017 ], [ 22.996068, 59.838211 ] ], [ [ 22.996068, 59.838211 ], [ 22.996332, 59.838315 ], [ 22.996677, 59.838450 ], [ 22.996848, 59.838518 ] ], [ [ 22.996848, 59.838518 ], [ 22.997046, 59.838596 ] ], [ [ 22.997046, 59.838596 ], [ 22.997521, 59.838783 ], [ 22.998238, 59.839068 ] ], [ [ 22.998238, 59.839068 ], [ 22.998376, 59.839123 ], [ 22.998790, 59.839289 ], [ 22.999160, 59.839438 ], [ 22.999280, 59.839488 ] ], [ [ 22.999280, 59.839488 ], [ 22.999679, 59.839655 ], [ 23.000090, 59.839827 ], [ 23.000279, 59.839905 ] ], [ [ 23.000279, 59.839905 ], [ 23.000456, 59.839976 ] ], [ [ 23.000456, 59.839976 ], [ 23.000575, 59.840029 ], [ 23.001402, 59.840410 ], [ 23.002182, 59.840767 ] ], [ [ 23.002182, 59.840767 ], [ 23.002438, 59.840884 ], [ 23.002827, 59.841063 ], [ 23.003897, 59.841555 ], [ 23.004722, 59.841933 ], [ 23.005017, 59.842070 ] ] ])
        });

        //load_road_from_geojson([ [ [ 25.130102, 60.254550 ], [ 25.129555, 60.254993 ], [ 25.128969, 60.255410 ], [ 25.128535, 60.255667 ] ], [ [ 25.129964, 60.254925 ], [ 25.129826, 60.255034 ], [ 25.129250, 60.255438 ] ], [ [ 25.130474, 60.254510 ], [ 25.130323, 60.254643 ] ], [ [ 25.138697, 60.248901 ], [ 25.138141, 60.249119 ], [ 25.137179, 60.249524 ], [ 25.136413, 60.249885 ], [ 25.135213, 60.250526 ], [ 25.134586, 60.250883 ], [ 25.134065, 60.251217 ], [ 25.133088, 60.251941 ], [ 25.132373, 60.252593 ], [ 25.131862, 60.253118 ], [ 25.131448, 60.253559 ], [ 25.131109, 60.253920 ], [ 25.130731, 60.254284 ], [ 25.130474, 60.254510 ] ], [ [ 25.146371, 60.245331 ], [ 25.146259, 60.245393 ] ], [ [ 25.146086, 60.245284 ], [ 25.146071, 60.245292 ], [ 25.145947, 60.245360 ] ], [ [ 25.130224, 60.254438 ], [ 25.130102, 60.254550 ] ], [ [ 25.138314, 60.248886 ], [ 25.137606, 60.249177 ], [ 25.136808, 60.249530 ], [ 25.135763, 60.250047 ], [ 25.134874, 60.250535 ], [ 25.134066, 60.251046 ], [ 25.133407, 60.251500 ], [ 25.132784, 60.251990 ], [ 25.132357, 60.252376 ], [ 25.132115, 60.252591 ], [ 25.131796, 60.252905 ], [ 25.131492, 60.253214 ], [ 25.131217, 60.253489 ], [ 25.130832, 60.253841 ], [ 25.130394, 60.254281 ], [ 25.130224, 60.254438 ] ], [ [ 25.130323, 60.254643 ], [ 25.129964, 60.254925 ] ], [ [ 25.146259, 60.245393 ], [ 25.146102, 60.245479 ], [ 25.145348, 60.245889 ], [ 25.144495, 60.246331 ], [ 25.142842, 60.247123 ], [ 25.141822, 60.247589 ], [ 25.140559, 60.248138 ], [ 25.139587, 60.248536 ], [ 25.138813, 60.248856 ], [ 25.138697, 60.248901 ] ], [ [ 25.145947, 60.245360 ], [ 25.145618, 60.245540 ], [ 25.144599, 60.246091 ], [ 25.143716, 60.246533 ], [ 25.142814, 60.246977 ], [ 25.142107, 60.247298 ], [ 25.141467, 60.247591 ], [ 25.140640, 60.247968 ], [ 25.139897, 60.248269 ], [ 25.139183, 60.248555 ], [ 25.138688, 60.248750 ], [ 25.138314, 60.248886 ] ] ])

        function load_road_from_geojson(prediction, source_name, layer_name, multiLineString)
        {
            map.addSource(source_name, {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'MultiLineString',
                        'coordinates': multiLineString
                    }
                },
            });

            const marker_source = source_name + "_marker"
            const marker_name = source_name + "_marker"
            const prediction_formatted = prediction + " km/h"

            //add markers (kilometer prediction) source
            map.addSource(marker_source, {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': [ 
                    {
                        // feature for Mapbox DC
                        'type': 'Feature',
                        'geometry': {
                        'type': 'Point',
                            'coordinates': [multiLineString[0][0][0], multiLineString[0][0][1]]
                        },
                        'properties': {
                            'title': prediction_formatted
                        }
                    },
                    ]
                }
            });


            map.addLayer({
                'id': layer_name,
                'type': 'line',
                'source': source_name,
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': 'red',
                    'line-width': 4
                }
            });

            //add markers (kilometer prediction) text layer
            map.addLayer({
                'id': marker_name,
                'type': 'symbol',
                'source': marker_source,
                'layout': {
                    'icon-image': 'custom-marker',
                    // get the title name from the source's "title" property
                    'text-field': ['get', 'title'],
                    'text-font': [
                        'Open Sans Semibold',
                        'Arial Unicode MS Bold'
                    ],
                    'text-offset': [0, 1.25],
                    'text-anchor': 'top'
                },
                paint: {
                    "text-color": "black"
                }
            });

            //console.log("added road")
            //console.log(multiLineString[0][0])

            map.flyTo({
                zoom: 12,
                center: multiLineString[0][0]
            });
        }

        async function fetch_prediction(coords)
        {
            const lon = JSON.stringify(coords.lng)
            const lat = JSON.stringify(coords.lat)

            if(debug)
            {
                console.log("Recieved coords:")
                console.log(coords)

                console.log("Longitude:")
                console.log(lon)
                console.log("Latitude:")
                console.log(lat)
            }
            
            //this would be cleaner with string formatting, but I couldnt get it to work
            const apiPath = "http://127.0.0.1:8000/api/get-pred&lat=" + lat + "&lon=" + lon 
            //const response = await fetch('http://127.0.0.1:8000/api/get-pred&lat= ${lat} &lon= ${lon} ')

            const response = await fetch(apiPath)
                
            const road = await response.json();
            const road1 = JSON.stringify(road)

            return road;
        }

        async function fetch_coordinates(roadId)
        {
            var apiPath = "https://tie.digitraffic.fi/api/v2/metadata/forecast-sections/" + roadId;
            const response = await fetch(apiPath)
            const coords = await response.json();
            
            return coords;
        }

        async function fetch_geodata(roadNumber, roadSectionId)
        {
            // API call to the server
            // Get the geodata of the road section
            const apiPath = "http://127.0.0.1:8000/api/get-geojson&roadNumber=" + roadNumber + "&roadSectionId=" + roadSectionId 
            const response = await fetch(apiPath)
            const geodata = await response.json();
            
            return geodata;
        }

        function switch_language(language) 
        {
            map.setLayoutProperty('country-label', 'text-field', [
                "get",
                `name_${language}`
            ]);
        }
    </script>
{% endblock %}
